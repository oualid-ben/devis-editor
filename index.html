<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Éditeur de Devis</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 40px;
      box-shadow: 
        0 32px 64px rgba(0, 0, 0, 0.15),
        0 0 0 1px rgba(255, 255, 255, 0.1);
      animation: slideIn 0.6s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header {
      text-align: center;
      margin-bottom: 48px;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .header p {
      color: #64748b;
      font-size: 1.1rem;
    }

    .section {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 32px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .section:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .form-group {
      position: relative;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      transition: color 0.2s ease;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: rgba(255, 255, 255, 1);
    }

    .form-group input:focus + label, .form-group select:focus + label {
      color: #667eea;
    }

    .required::after {
      content: ' *';
      color: #ef4444;
    }

    .table-container {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
      margin-bottom: 32px;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
      padding: 20px 16px;
      text-align: left;
      white-space: nowrap;
    }

    td {
      padding: 16px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
    }

    tbody tr {
      transition: all 0.2s ease;
    }

    tbody tr:hover {
      background: rgba(102, 126, 234, 0.05);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    td input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.875rem;
      background: rgba(255, 255, 255, 0.8);
      transition: all 0.2s ease;
    }

    td input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
      background: white;
    }

    .ht, .ttc {
      text-align: right;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      color: #1e293b;
    }

    .btn {
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eaa, #764ba2);
      color: white;
      padding: 16px 32px;
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 20px 40px;
      font-size: 1.1rem;
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      padding: 8px 16px;
      font-size: 0.875rem;
      border-radius: 8px;
    }

    .btn-danger:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .totals-section {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-radius: 16px;
      padding: 32px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      margin-top: 32px;
    }

    .totals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .total-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .total-item:last-child {
      border-bottom: none;
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
    }

    .total-label {
      color: #64748b;
      font-weight: 500;
    }

    .total-value {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .discount-section {
      display: flex;
      align-items: end;
      gap: 24px;
      margin: 24px 0;
      padding: 24px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #667eea;
    }

    .download-section {
      text-align: center;
      margin-top: 48px;
    }

    .warning-banner {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
    }

    .compliance-section {
      background: rgba(16, 185, 129, 0.1);
      border: 2px solid rgba(16, 185, 129, 0.2);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
    }

    .compliance-title {
      color: #059669;
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s ease;
    }

    .checkbox-item:hover {
      background: rgba(16, 185, 129, 0.05);
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #10b981;
    }

    .checkbox-item label {
      font-size: 0.9rem;
      color: #374151;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .container {
        padding: 24px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .section {
        padding: 24px;
      }
      
      .grid {
        grid-template-columns: 1fr;
      }
      
      .discount-section {
        flex-direction: column;
        align-items: stretch;
      }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>✨ Éditeur de Devis</h1>
      <p>Créez des devis professionnels conformes aux obligations légales</p>
    </div>

    <!-- VÉRIFICATION CONFORMITÉ -->
    <div class="compliance-section">
      <div class="compliance-title">
        ✅ Vérification de conformité légale
      </div>
      <div class="checkbox-list" id="compliance-checklist">
        <!-- Les éléments de conformité seront générés dynamiquement -->
      </div>
    </div>

    <!-- MÉTA DEVIS -->
    <div class="section">
      <h3 class="section-title">📋 Informations du devis</h3>
      <div class="grid">
        <div class="form-group">
          <label class="required">Numéro du devis</label>
          <input id="numeroDevis" value="D-MAN-250622-002" required>
        </div>
        <div class="form-group">
          <label class="required">Date</label>
          <input type="date" id="dateDevis" value="2025-06-22" required>
        </div>
        <div class="form-group">
          <label class="required">Objet</label>
          <input id="objetDevis" value="Peinture intérieure salon" required>
        </div>
        <div class="form-group">
          <label>Devise</label>
          <input id="devise" value="EUR">
        </div>
        <div class="form-group">
          <label class="required">Lieu d'exécution</label>
          <input id="lieuExecution" placeholder="Adresse du chantier" required>
        </div>
        <div class="form-group">
          <label class="required">Délai d'exécution</label>
          <input id="delaiExecution" placeholder="Ex: 5 jours ouvrés" required>
        </div>
        <div class="form-group">
          <label class="required">Validité du devis (jours)</label>
          <input type="number" id="validiteDevis" value="30" min="1" required>
        </div>
      </div>
    </div>

    <!-- INFO ARTISAN -->
    <div class="section">
      <h3 class="section-title">🏢 Informations de l'artisan / entreprise</h3>
      <div class="grid">
        <div class="form-group">
          <label class="required">Nom / Raison sociale</label>
          <input id="artisanNom" value="Entreprise ABC" required>
        </div>
        <div class="form-group">
          <label class="required">Forme juridique</label>
          <select id="formeJuridique" required>
            <option value="">Sélectionner...</option>
            <option value="Auto-entrepreneur">Auto-entrepreneur</option>
            <option value="EURL">EURL</option>
            <option value="SARL">SARL</option>
            <option value="SAS">SAS</option>
            <option value="SASU">SASU</option>
            <option value="SA">SA</option>
            <option value="Entreprise individuelle">Entreprise individuelle</option>
          </select>
        </div>
        <div class="form-group">
          <label class="required">Adresse du siège</label>
          <input id="artisanAdresse" value="12 rue des Lilas, 75000 Paris" required>
        </div>
        <div class="form-group">
          <label class="required">SIRET</label>
          <input id="siret" placeholder="123 456 789 00010" pattern="[0-9]{3} [0-9]{3} [0-9]{3} [0-9]{5}" required>
        </div>
        <div class="form-group">
          <label class="required">Code APE/NAF</label>
          <input id="codeAPE" placeholder="Ex: 4334Z" required>
        </div>
        <div class="form-group">
          <label class="required">RCS/RM + Ville</label>
          <input id="rcs" placeholder="Ex: RCS Paris 123456789" required>
        </div>
        <div class="form-group">
          <label>Capital social (€)</label>
          <input type="number" id="capitalSocial" placeholder="Obligatoire pour les sociétés" min="0">
        </div>
        <div class="form-group">
          <label>N° TVA intracommunautaire</label>
          <input id="tvaIntra" placeholder="FR12345678901">
        </div>
        <div class="form-group">
          <label class="required">Téléphone</label>
          <input id="artisanTel" value="06 00 00 00 00" required>
        </div>
        <div class="form-group">
          <label class="required">Email</label>
          <input type="email" id="artisanEmail" value="contact@abc.fr" required>
        </div>
      </div>
    </div>

    <!-- ASSURANCES -->
    <div class="section">
      <h3 class="section-title">🛡️ Assurances professionnelles</h3>
      <div class="grid">
        <div class="form-group">
          <label class="required">Assureur RC Pro</label>
          <input id="assureurRCPro" placeholder="Ex: AXA Assurances" required>
        </div>
        <div class="form-group">
          <label class="required">N° Police RC Pro</label>
          <input id="policeRCPro" placeholder="Ex: 123456789" required>
        </div>
        <div class="form-group">
          <label>Assureur Décennale</label>
          <input id="assureurDecennale" placeholder="Obligatoire pour travaux de construction">
        </div>
        <div class="form-group">
          <label>N° Police Décennale</label>
          <input id="policeDecennale" placeholder="Obligatoire pour travaux de construction">
        </div>
        <div class="form-group">
          <label class="required">Zone géographique couverte</label>
          <input id="zoneGeographique" placeholder="Ex: France métropolitaine" required>
        </div>
      </div>
    </div>

    <!-- INFO CLIENT -->
    <div class="section">
      <h3 class="section-title">👤 Informations client</h3>
      <div class="grid">
        <div class="form-group">
          <label class="required">Nom complet</label>
          <input id="clientNom" value="Jean Dupont" required>
        </div>
        <div class="form-group">
          <label class="required">Adresse complète</label>
          <input id="clientAdresse" placeholder="Adresse du client" required>
        </div>
        <div class="form-group">
          <label>Téléphone</label>
          <input id="clientTel" placeholder="Téléphone du client">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="clientEmail" placeholder="Email du client">
        </div>
      </div>
    </div>

    <!-- CONDITIONS COMMERCIALES -->
    <div class="section">
      <h3 class="section-title">💰 Conditions commerciales</h3>
      <div class="grid">
        <div class="form-group">
          <label class="required">Conditions de paiement</label>
          <select id="conditionsPaiement" required>
            <option value="">Sélectionner...</option>
            <option value="Comptant à la commande">Comptant à la commande</option>
            <option value="Acompte 30% - Solde à la livraison">Acompte 30% - Solde à la livraison</option>
            <option value="Acompte 50% - Solde à la livraison">Acompte 50% - Solde à la livraison</option>
            <option value="30 jours fin de mois">30 jours fin de mois</option>
            <option value="Personnalisé">Personnalisé</option>
          </select>
        </div>
        <div class="form-group">
          <label>Conditions personnalisées</label>
          <textarea id="conditionsPersonnalisees" placeholder="Détails supplémentaires sur les conditions de paiement"></textarea>
        </div>
        <div class="form-group">
          <label>Garanties offertes</label>
          <textarea id="garanties" placeholder="Ex: Garantie décennale, biennale, de parfait achèvement..."></textarea>
        </div>
        <div class="form-group">
          <label>Pénalités de retard</label>
          <input id="penalitesRetard" placeholder="Ex: 3 fois le taux légal en vigueur">
        </div>
      </div>
    </div>

    <!-- TABLE PRESTATIONS -->
    <div class="section">
      <h3 class="section-title">💼 Prestations</h3>
      <div class="table-container">
        <div class="table-wrapper">
          <table id="table-prestations">
            <thead>
              <tr>
                <th>Prestation</th>
                <th>Quantité</th>
                <th>Unité</th>
                <th>Prix unitaire</th>
                <th>TVA (%)</th>
                <th>Total HT</th>
                <th>Total TTC</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <button class="btn btn-primary" onclick="ajouterLigne()">
        ➕ Ajouter une ligne
      </button>
    </div>

    <!-- REMISE GLOBALE -->
    <div class="discount-section">
      <div class="form-group" style="flex: 1;">
        <label>Remise globale (€)</label>
        <input type="number" id="remise" value="0" oninput="recalculer()">
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="applyRemise" checked onchange="recalculer()">
        <label>Appliquer la remise</label>
      </div>
    </div>

    <!-- TOTAUX -->
    <div class="totals-section">
      <div id="totaux"></div>
    </div>

    <!-- CONDITIONS GÉNÉRALES -->
    <div class="section">
      <h3 class="section-title">📜 Conditions générales</h3>
      <div class="form-group">
        <label>Conditions Générales de Vente (CGV)</label>
        <textarea id="cgv" rows="6" placeholder="Indiquez vos conditions générales de vente ou référez-vous à celles disponibles sur votre site web...">Les présentes conditions générales s'appliquent à toutes nos prestations. Devis valable 30 jours. Règlement selon les conditions mentionnées ci-dessus. Tout retard de paiement entraînera l'application de pénalités. En cas de litige, seuls les tribunaux de [VILLE] seront compétents.</textarea>
      </div>
    </div>

    <div class="download-section">
      <button class="btn btn-primary" onclick="simulerDonneesOpenAI()" style="margin-right: 16px;">
        🤖 Simuler données OpenAI
      </button>
      <button class="btn btn-secondary" onclick="genererPDF()">
        📄 Télécharger le PDF
      </button>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    
    // Récupération des données depuis l'URL (workflow n8n)
    const urlParams = new URLSearchParams(location.search);
    let data = { prestations: [] };
    
    // Si des données sont passées via l'URL, les charger
    if (urlParams.get('data')) {
      try {
        data = JSON.parse(decodeURIComponent(urlParams.get('data')));
        data.prestations = data.prestations || [];
      } catch (e) {
        console.error('Erreur lors du parsing des données:', e);
        data = { prestations: [] };
      }
    }

    // Liste des éléments de conformité
    const complianceElements = [
      { id: 'numeroDevis', label: 'Numéro unique du devis', required: true },
      { id: 'dateDevis', label: 'Date du devis', required: true },
      { id: 'artisanNom', label: 'Raison sociale / Nom', required: true },
      { id: 'siret', label: 'Numéro SIRET', required: true },
      { id: 'codeAPE', label: 'Code APE/NAF', required: true },
      { id: 'rcs', label: 'RCS/RM + Ville', required: true },
      { id: 'formeJuridique', label: 'Forme juridique', required: true },
      { id: 'assureurRCPro', label: 'Assurance RC Professionnelle', required: true },
      { id: 'policeRCPro', label: 'N° Police RC Pro', required: true },
      { id: 'zoneGeographique', label: 'Zone géographique couverte', required: true },
      { id: 'validiteDevis', label: 'Durée de validité', required: true },
      { id: 'conditionsPaiement', label: 'Conditions de paiement', required: true },
      { id: 'delaiExecution', label: 'Délais d\'exécution', required: true },
      { id: 'lieuExecution', label: 'Lieu d\'exécution', required: true },
      { id: 'clientNom', label: 'Nom du client', required: true },
      { id: 'clientAdresse', label: 'Adresse du client', required: true }
    ];

    // Générer la liste de conformité
    function genererListeConformite() {
      const checklist = document.getElementById('compliance-checklist');
      checklist.innerHTML = '';
      
      complianceElements.forEach(element => {
        const div = document.createElement('div');
        div.className = 'checkbox-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `check-${element.id}`;
        checkbox.disabled = true;
        
        const label = document.createElement('label');
        label.htmlFor = `check-${element.id}`;
        label.textContent = element.label;
        
        div.appendChild(checkbox);
        div.appendChild(label);
        checklist.appendChild(div);
      });
    }

    // Vérifier la conformité
    function verifierConformite() {
      complianceElements.forEach(element => {
        const input = document.getElementById(element.id);
        const checkbox = document.getElementById(`check-${element.id}`);
        
        if (input && checkbox) {
          const isValid = input.value.trim() !== '';
          checkbox.checked = isValid;
          checkbox.parentElement.style.opacity = isValid ? '1' : '0.6';
        }
      });
    }

    // Ajouter des écouteurs d'événements pour la vérification en temps réel
    function ajouterEcouteursConformite() {
      complianceElements.forEach(element => {
        const input = document.getElementById(element.id);
        if (input) {
          input.addEventListener('input', verifierConformite);
          input.addEventListener('change', verifierConformite);
        }
      });
    }

    // Fonction pour traiter les données OpenAI n8n
    function processerDonneesOpenAI(openaiData) {
      console.log('Données OpenAI reçues:', openaiData);
      
      // Si les données contiennent directement les prestations
      if (openaiData.prestations && Array.isArray(openaiData.prestations)) {
        data.prestations = openaiData.prestations.map(p => ({
          typedeprestation: p.typedeprestation || p.prestation || p.description || '',
          quantite: {
            valeur: p.quantite?.valeur || p.quantite || 1,
            unite: p.quantite?.unite || p.unite || ''
          },
          prixunitaire: parseFloat(p.prixunitaire) || 0,
          tauxtva: parseFloat(p.tauxtva ||
