<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <title>Éditeur de Devis</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    *{box-sizing:border-box;font-family:'Segoe UI',Arial,sans-serif}
    body{margin:0;background:#f6f8fc}
    .container{max-width:1150px;margin:34px auto;padding:44px 50px;background:#fff;border-radius:18px;box-shadow:0 8px 28px #0001}
    h2{margin:0 0 28px;font-size:2rem;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:22px;margin-bottom:26px}
    label{display:flex;flex-direction:column;gap:6px;font-size:.94rem;font-weight:600;color:#222}
    input,select{padding:10px 11px;border:1px solid #cad3f8;border-radius:6px;background:#fdfefe;font-size:.94rem;width:100%}
    input[type=number]::-webkit-inner-spin-button{opacity:.35}
    #artisanBlock,#clientBlock{background:#f5f7fc;border-radius:12px;padding:20px 24px;margin-bottom:32px}
    #artisanBlock h3,#clientBlock h3{margin:0 0 12px;font-size:1.05rem;font-weight:700}
    .table-wrapper{overflow-x:auto;margin-bottom:20px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{background:#eef1fb;font-weight:600;font-size:.9rem;padding:10px 8px;border-radius:8px 8px 0 0;text-align:left}
    td{background:#fff;border:1px solid #edf2fa;padding:6px}
    td.ht,td.ttc{text-align:right;font-variant-numeric:tabular-nums}
    .action-btn{border:none;border-radius:6px;padding:10px 26px;font-size:1rem;cursor:pointer;transition:.15s}
    .add-btn{background:#5146e1;color:#fff;margin-bottom:18px}
    .add-btn:hover{background:#3c33c0}
    .delete-btn{background:#ff5252;color:#fff;padding:4px 11px;border-radius:4px;cursor:pointer}
    #totaux{background:#f0f4ff;border-radius:10px;padding:22px 26px;width:fit-content;margin-top:18px;font-size:1.04rem;font-weight:500}
    #totaux strong{font-size:1.15rem}
    .download-btn{background:#20b05b;color:#fff;font-weight:600;font-size:1.05rem;padding:15px 34px;border:none;border-radius:7px;box-shadow:0 2px 10px #1fa2722b;margin-top:26px;cursor:pointer}
    .download-btn:hover{background:#17924b}
    .flex{display:flex;align-items:center;gap:10px;margin:14px 0}
  </style>
</head>
<body>
<div class="container">
  <h2>Modifier les informations du devis</h2>

  <!-- MÉTA DEVIS -->
  <div class="grid">
    <label>Numéro du devis :<input id="numeroDevis" value="D-MAN-250622-002"></label>
    <label>Date :<input type="date" id="dateDevis" value="2025-06-22"></label>
    <label>Objet :<input id="objetDevis" value="Peinture intérieure salon"></label>
    <label>Devise :<input id="devise" value="EUR"></label>
  </div>

  <!-- INFO ARTISAN -->
  <div id="artisanBlock">
    <h3>Informations de l’artisan / entreprise</h3>
    <div class="grid">
      <label>Nom / Raison sociale :<input id="artisanNom" value="Entreprise ABC"></label>
      <label>Adresse :<input id="artisanAdresse" value="12 rue des Lilas, 75000 Paris"></label>
      <label>Téléphone :<input id="artisanTel" value="06 00 00 00 00"></label>
      <label>Email :<input id="artisanEmail" value="contact@abc.fr"></label>
    </div>
  </div>

  <!-- INFO CLIENT -->
  <div id="clientBlock">
    <h3>Informations client</h3>
    <div class="grid">
      <label>Nom complet :<input id="clientNom" value="Jean Dupont"></label>
      <label>Adresse :<input id="clientAdresse" placeholder="(optionnel)"></label>
    </div>
  </div>

  <!-- TABLE PRESTATIONS -->
  <div class="table-wrapper">
    <table id="table-prestations">
      <thead>
        <tr><th>Prestation</th><th>Quantité</th><th>Unité</th><th>Prix unitaire</th><th>TVA (%)</th><th>Total&nbsp;HT</th><th>Total&nbsp;TTC</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <button class="action-btn add-btn" onclick="ajouterLigne()">+ Ajouter une ligne</button>

  <!-- REMISE GLOBALE -->
  <div class="flex">
    <label>Remise globale (€) :<input type="number" id="remise" value="0" oninput="recalculer()"></label>
    <label style="flex:none"><input type="checkbox" id="applyRemise" checked onchange="recalculer()"> Appliquer</label>
  </div>

  <div id="totaux"></div>
  <button class="download-btn" onclick="genererPDF()">⬇️ Télécharger le PDF</button>
</div>

<script>
  const { jsPDF } = window.jspdf;
  let data = JSON.parse(decodeURIComponent(new URLSearchParams(location.search).get('data') || '{"prestations":[]}'));
  data.prestations = data.prestations || [];

  const tbody = document.querySelector('#table-prestations tbody');
  const remiseInput = document.getElementById('remise');
  const applyRemise = document.getElementById('applyRemise');

  function rowHTML(i, p) {
    return `<td><input value="${p.typedeprestation || ''}" oninput="data.prestations[${i}].typedeprestation=this.value"></td>
      <td><input type="number" min="0" value="${p.quantite?.valeur || 0}" oninput="data.prestations[${i}].quantite.valeur=parseFloat(this.value)||0;recalculer()"></td>
      <td><input value="${p.quantite?.unite || ''}" oninput="data.prestations[${i}].quantite.unite=this.value"></td>
      <td><input type="number" min="0" value="${p.prixunitaire || 0}" oninput="data.prestations[${i}].prixunitaire=parseFloat(this.value)||0;recalculer()"></td>
      <td><input type="number" min="0" value="${p.tauxtva || 20}" oninput="data.prestations[${i}].tauxtva=parseFloat(this.value)||0;recalculer()"></td>
      <td class="ht">0.00</td><td class="ttc">0.00</td>
      <td><button class="delete-btn" onclick="supprimer(${i})">✕</button></td>`
  }

  function render() {
    tbody.innerHTML = '';
    data.prestations.forEach((p, i) => {
      if (!p.quantite) p.quantite = { valeur: 0, unite: '' };
      const tr = document.createElement('tr');
      tr.innerHTML = rowHTML(i, p);
      tbody.appendChild(tr);
    });
    recalculer();
  }
  function ajouterLigne() {
    data.prestations.push({ typedeprestation: '', quantite: { valeur: 0, unite: '' }, prixunitaire: 0, tauxtva: 20 });
    render();
  }
  function supprimer(i) {
    data.prestations.splice(i, 1);
    render();
  }

  function recalculer() {
    let totalHT = 0, totalTVA = 0;
    tbody.querySelectorAll('tr').forEach((tr, i) => {
      const p = data.prestations[i];
      const ht = p.prixunitaire * p.quantite.valeur;
      const tva = ht * (p.tauxtva / 100);
      const ttc = ht + tva;
      totalHT += ht; totalTVA += tva;
      tr.querySelector('.ht').textContent = ht.toFixed(2);
      tr.querySelector('.ttc').textContent = ttc.toFixed(2);
    });
    const remise = applyRemise.checked ? (parseFloat(remiseInput.value) || 0) : 0;
    const sousTotal = totalHT - remise;
    const totalTTC = sousTotal + totalTVA;
    document.getElementById('totaux').innerHTML = `Total HT : €${totalHT.toFixed(2)}<br>Remise : €${remise.toFixed(2)}<br>Sous-total : €${sousTotal.toFixed(2)}<br>TVA : €${totalTVA.toFixed(2)}<br><strong>Total TTC : €${totalTTC.toFixed(2)}</strong>`;
  }

  function genererPDF() {
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });

    // ARTISAN & CLIENT HEADER --------------------------------------------------
    doc.setFontSize(18).text('Devis', 40, 40);
    doc.setFontSize(11);

    // Left column (artisan)
    const artisanLines = [
      document.getElementById('artisanNom').value,
      document.getElementById('artisanAdresse').value,
      `Téléphone : ${document.getElementById('artisanTel').value}`,
      `Email : ${document.getElementById('artisanEmail').value}`
    ];
    artisanLines.forEach((l, idx) => doc.text(l, 40, 70 + idx * 14));

    // Right column (client)
    const clientX = 340;
    const clientLines = [
      'Client :',
      document.getElementById('clientNom').value,
      document.getElementById('clientAdresse').value
    ];
    clientLines.forEach((l, idx) => doc.text(l, clientX, 70 + idx * 14));

    // Meta (num/date) under artisan block
    const metaY = 70 + Math.max(artisanLines.length, clientLines.length) * 14 + 16;
    doc.text(`Numéro : ${document.getElementById('numeroDevis').value}`, 40, metaY);
    doc.text(`Date : ${document.getElementById('dateDevis').value}`, 240, metaY);

    // Objet just before table
    doc.text(`Objet : ${document.getElementById('objetDevis').value}`, 40, metaY + 24);

    // TABLE --------------------------------------------------------------------
    const body = data.prestations.map(p => [
      p.typedeprestation,
      p.quantite.valeur,
      p.quantite.unite,
      p.prixunitaire,
      p.tauxtva,
      (p.quantite.valeur * p.prixunitaire).toFixed(2),
      (p.quantite.valeur * p.prixunitaire * (1 + p.tauxtva / 100)).toFixed(2)
    ]);

    doc.autoTable({
      startY: metaY + 44,
      head: [['Prestation', 'Qté', 'U', 'PU', 'TVA %', 'HT', 'TTC']],
      body,
      styles: { halign: 'center', fontSize: 9 },
      headStyles: { fillColor: [24, 90, 160], textColor: 255, fontStyle: 'bold' }
    });

    // Totaux block
    const finalY = doc.lastAutoTable.finalY || metaY + 64;
    doc.setFontSize(11);
    doc.text(document.getElementById('totaux').innerText.split('\n'), 40, finalY + 28);

    doc.save(`devis_${document.getElementById('clientNom').value.replace(/\s+/g, '_')}.pdf`);
  }

  // INIT ----------------------------------------------------------------------
  document.getElementById('clientNom').value = data.nomduclient || '';
  render();
</script>
</body>
</html>
