<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>√âditeur de Devis</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f9fafe;
      color: #333;
      padding: 40px;
      max-width: 1200px;
      margin: auto;
    }
    h2 {
      font-size: 28px;
      margin-bottom: 20px;
    }
    .meta-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    label {
      font-weight: 600;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 14px;
    }
    input[type="text"], input[type="date"], input[type="number"] {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #f1f3f5;
      font-size: 14px;
      font-weight: 600;
    }
    tr:not(:last-child) td {
      border-bottom: 1px solid #eee;
    }
    .actions {
      margin-top: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    button {
      background-color: #4f46e5;
      color: white;
      padding: 12px 20px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #3730a3;
    }
    #totaux {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #eee;
      font-size: 16px;
    }
    .highlight {
      font-weight: bold;
      font-size: 18px;
      color: #111;
    }
  </style>
</head>
<body>
  <h2>Modifier les informations du devis</h2>

  <div class="meta-info">
    <label>Num√©ro du devis :
      <input type="text" id="numeroDevis" value="D-MAN-250622-002">
    </label>
    <label>Date :
      <input type="date" id="dateDevis" value="2025-06-22">
    </label>
    <label>Objet :
      <input type="text" id="objetDevis" value="Peinture int√©rieure salon">
    </label>
    <label>Devise :
      <input type="text" value="EUR" disabled>
    </label>
  </div>

  <div id="nomClient" style="margin-bottom: 10px; font-weight: 600; font-size: 16px;"></div>

  <table id="table-prestations">
    <thead>
      <tr>
        <th>Prestation</th>
        <th>Quantit√©</th>
        <th>Unit√©</th>
        <th>Prix Unitaire</th>
        <th>TVA (%)</th>
        <th>Total HT</th>
        <th>Total TTC</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="actions">
    <button onclick="ajouterLigne()">‚ûï Ajouter une ligne</button>
    <label>Remise globale (‚Ç¨) :
      <input type="number" id="remise" value="0" onchange="recalculer()" />
    </label>
  </div>

  <div id="totaux"></div>

  <div class="actions">
    <button onclick="envoyer()">‚úÖ G√©n√©rer le PDF</button>
    <button onclick="window.print()">üì• T√©l√©charger le PDF</button>
  </div>

  <script>
    let data = JSON.parse(decodeURIComponent(new URLSearchParams(window.location.search).get("data")));
    document.getElementById("nomClient").textContent = `Client : ${data.nomduclient}`;

    const tbody = document.querySelector("#table-prestations tbody");

    function ajouterLigne(presta = { typedeprestation: '', quantite: { valeur: 1, unite: '' }, prixunitaire: 0, tauxtva: 20 }) {
      const i = data.prestations.length;
      data.prestations.push(presta);
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="text" value="${presta.typedeprestation}" onchange="data.prestations[${i}].typedeprestation=this.value; recalculer()" /></td>
        <td><input type="number" value="${presta.quantite.valeur}" onchange="data.prestations[${i}].quantite.valeur=parseFloat(this.value); recalculer()" /></td>
        <td><input type="text" value="${presta.quantite.unite}" onchange="data.prestations[${i}].quantite.unite=this.value" /></td>
        <td><input type="number" value="${presta.prixunitaire}" onchange="data.prestations[${i}].prixunitaire=parseFloat(this.value); recalculer()" /></td>
        <td><input type="number" value="${presta.tauxtva}" onchange="data.prestations[${i}].tauxtva=parseFloat(this.value); recalculer()" /></td>
        <td class="ht">0</td>
        <td class="ttc">0</td>
      `;
      tbody.appendChild(row);
      recalculer();
    }

    data.prestations.forEach(ajouterLigne);

    function recalculer() {
      let totalHT = 0;
      let totalTVA = 0;
      tbody.querySelectorAll("tr").forEach((row, i) => {
        const p = data.prestations[i];
        const ht = p.prixunitaire * p.quantite.valeur;
        const tva = ht * (p.tauxtva / 100);
        const ttc = ht + tva;
        totalHT += ht;
        totalTVA += tva;
        row.querySelector(".ht").textContent = ht.toFixed(2);
        row.querySelector(".ttc").textContent = ttc.toFixed(2);
      });
      const remise = parseFloat(document.getElementById("remise").value || 0);
      const sousTotal = totalHT - remise;
      const totalTTC = sousTotal + totalTVA;

      document.getElementById("totaux").innerHTML = `
        Total HT : ‚Ç¨${totalHT.toFixed(2)}<br>
        Remise : ‚Ç¨${remise.toFixed(2)}<br>
        Sous-total : ‚Ç¨${sousTotal.toFixed(2)}<br>
        TVA : ‚Ç¨${totalTVA.toFixed(2)}<br>
        <span class="highlight">Total TTC : ‚Ç¨${totalTTC.toFixed(2)}</span>
      `;
    }

    function envoyer() {
      data.numeroDevis = document.getElementById("numeroDevis").value;
      data.dateDevis = document.getElementById("dateDevis").value;
      data.objetDevis = document.getElementById("objetDevis").value;
      data.remiseGlobale = parseFloat(document.getElementById("remise").value || 0);

      fetch("https://ton-webhook-n8n.com/webhook-url", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      })
      .then(res => res.ok ? alert("‚úÖ Donn√©es envoy√©es, PDF en cours de g√©n√©ration...") : alert("‚ùå Erreur lors de l'envoi"))
      .catch(() => alert("‚ùå Erreur r√©seau"));
    }
  </script>
</body>
</html>


